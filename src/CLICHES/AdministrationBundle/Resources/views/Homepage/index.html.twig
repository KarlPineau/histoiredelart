{# src/HDA/AdministrationBundle/Resources/views/Index/index.html.twig #}
 
{% extends "CLICHESAdministrationBundle::layout.html.twig" %}
 
{% block title %}
    Administration - {{ parent() }}
{% endblock %}

{% block brandtitle %}
    Administration
{% endblock %}

{% block breadcrumb %}
    {{ parent() }}
{% endblock %}

{% block h1 %}
    Administration
{% endblock %}

{% block h1_extend %}
    <div class="btn-group">
        <a href="{{ path('cliches_administration_statistics_index') }}" class="btn btn-default" title="Statistiques" data-toggle="tooltip" data-placement="left"><span class="glyphicon glyphicon-stats"></span></a>
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Actions <span class="badge">{{ countModifications }}</span> <span class="caret"></span>
        </button>
        <ul class="dropdown-menu dropdown-menu-right">
            <li><a href="{{path('cliches_administration_playersuggest_index')}}">Modifications <span class="badge">{{ countModifications }}</span></a></li>
            <li><a href="{{ path('cliches_administration_playersession_index') }}">Historique des sessions</a></li>
            <li><a href="{{ path('cliches_administration_statistics_statisticsbyteaching') }}">Stats par Enseignement</a></li>
        </ul>
    </div>

{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-xs-12">
            {% for flashMessage in app.session.flashbag.get('notice') %}
                <div class="alert alert-success">
                    {{ flashMessage }}
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="well">
                <canvas id="sessionsInTime" width="400" height="200"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div>
                <div class="pull-right">Total: {{ countTeachingTestVotes }} - <a href="{{ path('cliches_administration_votes_statistics') }}" class="btn btn-default" title="Statistiques des votes" data-toggle="tooltip" data-placement="left"><span class="glyphicon glyphicon-stats"></span></a></div>
                <h3>Derniers votes :</h3>
            </div>
            <table class="table table-bordered table-striped">
                <tr>
                    <th>#</th>
                    <th>Relation</th>
                    <th>Vote</th>
                    <th>User</th>
                </tr>
                {# -- Cette boucle utilise des entités pures -- #}
                {% for teachingTestVote in teachingTestVotes %}
                    {% set entity = data_data_entity_service.getByView(teachingTestVote.teachingTest.view) %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            <a href="{{ path('data_teaching_teaching_view', {'slug': teachingTestVote.teachingTest.teaching.slug}) }}">{{ teachingTestVote.teachingTest.teaching.name }}</a>
                            <span class="glyphicon glyphicon-resize-horizontal"></span>
                            <a href="{{ path(data_data_entity_routing_service.getRoutingView(), {'id': entity.id}) }}">{{ data_data_entity_service.getName(entity) }}</a>
                        </td>
                        <td>
                            {% if teachingTestVote.vote == true %}<span class="text-success">Oui</span>
                            {% elseif teachingTestVote.vote == false %}<span class="text-warning">Non</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if teachingTestVote.createUser != null %}{{ teachingTestVote.createUser.email }}
                            {% else %}Inconnu
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="4">Aucun vote à l'heure actuelle</td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>
{% endblock %}

{% block javascript_sub %}
    {{ parent() }}
    <script src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.3/Chart.bundle.js"></script>
    <script>
        var sessionInTime = $("#sessionsInTime");
        var labels = [];
            function daysInMonth(month, year) {
                return new Date(year, month, 0).getDate();
            }
            var today = new Date();
            var yyyy = today.getFullYear();
            var month = today.getMonth()+1;
            var lastDay = today.getDate()-15;

            for(var i = 0 ; i <= 15 ; i++) {
                var current = lastDay+i;
                if(current > 0) {
                    labels.push(current + '/' + month);
                } else {
                    labels.push(daysInMonth(month-1, yyyy)-i);
                }
            }

        $.ajax({
            dataType: "json",
            url: Routing.generate('cliches_administration_statistics_getstatistiques_intime'),
            success: function(data){
                var sessionInTimeChart = new Chart(sessionInTime, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Sessions du jour",
                                fill: false,
                                lineTension: 0.1,
                                backgroundColor: "rgba(75,192,192,0.4)",
                                borderColor: "rgba(75,192,192,1)",
                                borderCapStyle: 'butt',
                                borderDash: [],
                                borderDashOffset: 0.0,
                                borderJoinStyle: 'miter',
                                pointBorderColor: "rgba(75,192,192,1)",
                                pointBackgroundColor: "#fff",
                                pointBorderWidth: 1,
                                pointHoverRadius: 5,
                                pointHoverBackgroundColor: "rgba(75,192,192,1)",
                                pointHoverBorderColor: "rgba(220,220,220,1)",
                                pointHoverBorderWidth: 2,
                                pointRadius: 1,
                                pointHitRadius: 10,
                                data: data,
                            }
                        ]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero:true
                                }
                            }]
                        }
                    }
                });
            },
            error: function(error){
                console.log(dump(error));
            }
        });
    </script>
{% endblock %}